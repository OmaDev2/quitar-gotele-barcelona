---
import HeroBlock from "./blocks/HeroBlock.astro";
import FeaturesBlock from "./blocks/FeaturesBlock.astro";
import MapBlock from "./blocks/MapBlock.astro";
import FinalCTA from "./FinalCTA.astro";
import FaqAccordion from "./FaqAccordion.astro";
import Breadcrumbs from "./Breadcrumbs.astro";
import LocationsSection from "./LocationsSection.astro";
import Testimonials from "./Testimonials.astro";
import { ArrowRight, CheckCircle, Shield } from "lucide-react";

// Home Blocks
import HomeHero from "./blocks/home/HomeHero.astro";
import HomeServices from "./blocks/home/HomeServices.astro";
import HomeAbout from "./blocks/home/HomeAbout.astro";
import HomeFeatures from "./blocks/home/HomeFeatures.astro";
import HomeContact from "./blocks/home/HomeContact.astro";
import HomeProcess from "./blocks/home/HomeProcess.astro";
import HomeServicesOnePage from "./blocks/home/HomeServicesOnePage.astro";

// New Modular Blocks
import PricingBlock from "./blocks/PricingBlock.astro";
import StatsBlock from "./blocks/StatsBlock.astro";
import LogosBlock from "./blocks/LogosBlock.astro";
import BeforeAfterBlock from "./blocks/BeforeAfterBlock.astro";
import PriceFromBlock from "./blocks/PriceFromBlock.astro";
import ContentBlock from "./blocks/Content.astro";
import ContentWithSidebar from "./blocks/ContentWithSidebar.astro";
import ServiceAreas from "./blocks/ServiceAreas.astro";

import type { Service, Location, Block, Coordinates, FAQItem } from "../types";

interface Props {
    blocks: Block[];
    locationName?: string;
    locationType?: "residencial" | "industrial" | "centro";
    zipCodes?: string[];
    heroImage?: string;
    phone?: string;
    siteName?: string;
    niche?: string;
    title?: string;
    city?: string;
    coordinates?: Coordinates;
    content?: any; // Still any for now as MDX props are complex
    mdxComponents?: any;
    services?: Service[];
    faq?: FAQItem[];
    allLocations?: Location[];
    allServices?: Service[]; // New prop for Auto lookup
    currentSlug?: string;
    whatsapp?: string;
    isHome?: boolean;
    isService?: boolean;
    isLocation?: boolean;
    config?: any; // Global settings
}

const {
    blocks,
    locationName,
    locationType,
    zipCodes,
    heroImage,
    phone,
    siteName,
    niche,
    title,
    city,
    coordinates,
    content: Content,
    mdxComponents,
    services,
    allServices,
    faq,
    allLocations,
    currentSlug,
    whatsapp,
    isHome,
    isService,
    isLocation,
    config,
} = Astro.props;
---

{
    blocks.map((block, index) => {
        const { discriminant, value } = block;
        // Alternar fondos: Par = Secondary (Oscuro), Impar = Surface (Claro/Contraste)
        const bgClass = index % 2 === 0 ? "bg-secondary" : "bg-surface";

        switch (discriminant) {
            case "hero":
                if (isHome) {
                    return <HomeHero hero={value} config={config} />;
                }
                return (
                    <div class="relative group">
                        <Breadcrumbs
                            locationName={locationName}
                            serviceName={title}
                            isLocation={isLocation}
                            isService={isService}
                        />

                        <HeroBlock
                            locationName={locationName}
                            locationType={locationType}
                            zipCodes={zipCodes}
                            heroImage={value?.heroImage || heroImage}
                            phone={phone}
                            siteName={siteName}
                            niche={niche}
                            title={value?.title || title}
                            subtitle={value?.subtitle}
                        />
                    </div>
                );

            case "services_grid":
                return (
                    <HomeServices
                        servicesSection={value}
                        featuredServices={services}
                        customServices={value?.services}
                        allServices={allServices}
                        city={city}
                        bgClass={bgClass}
                    />
                );

            case "services_list":
                return (
                    <HomeServicesOnePage
                        title={value?.title}
                        subtitle={value?.subtitle}
                        services={value?.items}
                        bgClass={bgClass}
                    />
                );

            case "about":
                return <HomeAbout aboutSection={value} bgClass={bgClass} />;

            case "features":
                const featuresData =
                    value?.features || value?.items || value || [];
                if (isHome) {
                    return (
                        <HomeFeatures
                            features={featuresData}
                            title={value?.title}
                            city={city}
                            bgClass={bgClass}
                        />
                    );
                }
                return (
                    <FeaturesBlock
                        locationName={locationName}
                        city={city}
                        title={value?.title}
                        subtitle={value?.subtitle}
                        items={featuresData}
                        bgClass={bgClass}
                    />
                );

            case "process":
                return value ? (
                    <HomeProcess process={value} bgClass={bgClass} />
                ) : null;

            case "testimonials":
                const testimonialsArray = value?.testimonials || value || [];
                return (
                    <Testimonials
                        title={value?.title}
                        subtitle={value?.subtitle}
                        testimonials={
                            Array.isArray(testimonialsArray)
                                ? testimonialsArray.map((t: any) => ({
                                      name: t.author || t.name,
                                      text: t.quote || t.text,
                                      location: t.location,
                                      initials: t.initials,
                                      rating: t.rating || 5,
                                  }))
                                : []
                        }
                        bgClass={bgClass}
                    />
                );

            case "map":
                return (
                    <MapBlock
                        coordinates={coordinates}
                        locationName={locationName}
                        zipCodes={zipCodes}
                    />
                );

            case "cta":
                return (
                    <FinalCTA
                        title={value?.title}
                        subtitle={value?.subtitle}
                        buttonText={value?.buttonText}
                        buttonLink={value?.buttonLink}
                        bgClass={bgClass}
                    />
                );

            case "locations":
                return (
                    <LocationsSection
                        bgClass={bgClass}
                        locationsSection={value}
                    />
                );

            case "contact":
                return (
                    <HomeContact
                        config={config}
                        bgClass={bgClass}
                        contactSection={value}
                    />
                );

            case "faq":
                const faqItems = value?.faqs || value?.questions || value || []; // Handle both formats
                if (isHome) {
                    return faqItems && faqItems.length > 0 ? (
                        <div class={`py-20 ${bgClass}`}>
                            <div class="container mx-auto px-4 max-w-4xl">
                                <h2 class="text-3xl font-heading font-bold text-heading mb-4 text-center">
                                    {value?.title || "Preguntas Frecuentes"}
                                </h2>
                                {value?.subtitle && (
                                    <p class="text-body text-center mb-12 max-w-2xl mx-auto">
                                        {value.subtitle}
                                    </p>
                                )}
                                <FaqAccordion items={faqItems} title="" />
                            </div>
                        </div>
                    ) : null;
                }
                return (
                    faqItems &&
                    faqItems.length > 0 && (
                        <section class="py-20 bg-surface/30">
                            <div class="container mx-auto px-4 max-w-4xl">
                                <FaqAccordion
                                    title={`Preguntas Frecuentes sobre ${title || locationName}`}
                                    items={faqItems}
                                />
                            </div>
                        </section>
                    )
                );

            case "content":
                const urgencyStyle = value?.urgencyBoxStyle || "none";

                if (value?.sections && value.sections.length > 0) {
                    return (
                        <ContentBlock
                            title={value?.title}
                            sections={value?.sections}
                            bgClass={bgClass}
                        />
                    );
                }
                if (isHome) {
                    return (
                        <section class={`py-20 ${bgClass}`}>
                            <div class="container mx-auto px-4 max-w-4xl">
                                <h2 class="text-3xl font-heading font-bold text-heading mb-8">
                                    {value?.title}
                                </h2>
                                <div class="prose prose-invert prose-lg text-body">
                                    {Content && (
                                        <Content components={mdxComponents} />
                                    )}
                                </div>
                            </div>
                        </section>
                    );
                }
                return (
                    <ContentWithSidebar
                        title={title}
                        niche={niche}
                        locationName={locationName}
                        city={city}
                        phone={phone}
                        whatsapp={whatsapp}
                        urgencyStyle={urgencyStyle}
                        content={Content}
                        mdxComponents={mdxComponents}
                        services={services}
                        allLocations={allLocations}
                        currentSlug={currentSlug}
                        bgClass={bgClass}
                    />
                );
            case "service_areas":
                return (
                    <ServiceAreas
                        title={value?.title}
                        subtitle={value?.subtitle}
                        areas={value?.areas}
                        bgClass={bgClass}
                    />
                );

            case "pricing":
                return (
                    <PricingBlock
                        title={value?.title}
                        subtitle={value?.subtitle}
                        note={value?.note}
                        plans={value?.plans}
                        bgClass={bgClass}
                    />
                );

            case "stats":
                return (
                    <StatsBlock
                        title={value?.title}
                        stats={value?.stats}
                        bgClass={bgClass}
                    />
                );

            case "logos":
                return (
                    <LogosBlock
                        title={value?.title}
                        logos={value?.logos}
                        bgClass={bgClass}
                    />
                );

            case "before_after":
                return (
                    <BeforeAfterBlock
                        title={value?.title}
                        subtitle={value?.subtitle}
                        beforeImage={value?.beforeImage}
                        afterImage={value?.afterImage}
                        beforeLabel={value?.beforeLabel}
                        afterLabel={value?.afterLabel}
                        bgClass={bgClass}
                    />
                );

            case "price_from":
                return (
                    <PriceFromBlock
                        price={value?.price}
                        unit={value?.unit}
                        title={value?.title}
                        subtitle={value?.subtitle}
                        buttonText={value?.buttonText}
                        buttonLink={value?.buttonLink}
                        isOffer={value?.isOffer}
                        bgClass={bgClass}
                    />
                );

            default:
                return null;
        }
    })
}
