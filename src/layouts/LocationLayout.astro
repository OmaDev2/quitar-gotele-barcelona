---
import Layout from "./Layout.astro";
import Footer from "../components/Footer.astro";
import FinalCTA from "../components/FinalCTA.astro";
import FaqAccordion from "../components/FaqAccordion.astro";
import WhatsAppButton from "../components/WhatsAppButton.astro";
import { CheckCircle, ArrowRight, Home, ChevronRight } from "lucide-react";
import { getCollection } from "astro:content";
import { getSettings } from "../lib/settings";

import BlockRenderer from "../components/BlockRenderer.astro";
import type { Service, Location, Block, Coordinates, FAQItem } from "../types";

interface Props {
    locationName: string;
    locationType: "residencial" | "industrial" | "centro";
    zipCodes?: string[];
    heroImage?: string;
    heroTitle?: string;
    heroSubtitle?: string;
    coordinates?: Coordinates;
    faq?: FAQItem[];
    content: any; // Astro component derived type
    siteName?: string;
    phone?: string;
    whatsapp?: string;
    niche?: string;
    city?: string;
    services?: Service[];
    allLocations?: Location[];
    title?: string;
    blocks?: Block[];
    currentSlug?: string;
    pageTitle: string;
    pageDescription: string;
    schema: any;
    mdxComponents?: any;
}

// 1. RECUPERAR PROPS
let props = Astro.props;

// 2. LÓGICA DE SEGURIDAD (AUTOFETCH)
// Si faltan datos globales (porque la página padre no los pasó), los recuperamos aquí.
const settings = await getSettings();
const servicesData = props.services || (await getCollection("services"));
const locationsData = props.allLocations || (await getCollection("locations"));

// Consolidamos los datos finales
const siteName = props.siteName || settings.siteName;
const phone = props.phone || settings.phone;
const whatsapp = props.whatsapp || settings.whatsapp;
const niche = props.niche || settings.niche;
const city = props.city || settings.city;
const services = servicesData;
const allLocations = locationsData;
const currentSlug = props.currentSlug || "";

// 3. GESTIÓN DE BLOQUES
const defaultBlocks: Block[] = [
    { discriminant: "hero" },
    { discriminant: "features" },
    { discriminant: "content" },
    { discriminant: "cta" },
    { discriminant: "map" },
];

const finalBlocks =
    props.blocks && props.blocks.length > 0 ? props.blocks : defaultBlocks;
---

<Layout
    title={props.pageTitle}
    description={props.pageDescription}
    schema={props.schema}
>
    {
        /* Breadcrumbs integrados visualmente (Opcional: mover dentro del Hero si se prefiere) */
    }
    {
        /* Por ahora, los eliminamos de la barra superior "rota" y los dejamos solo como texto auxiliar si es necesario,
        o mejoramos la barra para que sea parte del diseño premium */
    }

    <div class="relative">
        {
            /* 
         NOTA: Movemos el renderizado de bloques aquí. 
         El HeroBlock debería incluir idealmente los breadcrumbs si se quiere un diseño integrado.
         Si no, una barra flotante transparente.
      */
        }

        {
            (
                <BlockRenderer
                    blocks={finalBlocks}
                    locationName={props.locationName}
                    locationType={props.locationType}
                    zipCodes={props.zipCodes}
                    heroImage={props.heroImage}
                    heroTitle={props.heroTitle}
                    heroSubtitle={props.heroSubtitle}
                    phone={phone}
                    siteName={siteName}
                    niche={niche}
                    title={props.title}
                    city={city}
                    coordinates={props.coordinates}
                    content={props.content}
                    mdxComponents={props.mdxComponents}
                    services={services}
                    faq={props.faq}
                    allLocations={allLocations}
                    currentSlug={currentSlug}
                    whatsapp={whatsapp}
                    isLocation={true}
                />
            )
        }

        <WhatsAppButton />
        <Footer />
    </div>

    <style>
        @keyframes formPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(var(--color-primary), 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(var(--color-primary), 0);
                transform: scale(1.02);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(var(--color-primary), 0);
                transform: scale(1);
            }
        }
        .form-highlight {
            animation: formPulse 1s ease-out 2;
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const formLink = document.querySelector('a[href="#formulario"]');
            const formElement = document.getElementById("formulario");
            if (formLink && formElement) {
                formLink.addEventListener("click", (event) => {
                    event.preventDefault();
                    formElement.scrollIntoView({
                        behavior: "smooth",
                        block: "center",
                    });
                    setTimeout(() => {
                        formElement.classList.add("form-highlight");
                        setTimeout(
                            () =>
                                formElement.classList.remove("form-highlight"),
                            2000,
                        );
                    }, 500);
                });
            }
        });
    </script>
</Layout>
